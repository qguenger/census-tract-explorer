<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pittsburgh Tract Explorer (Static)</title>
  <!-- Plotly.js from CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { width: 60%; height: 400px; margin: auto; }
    #charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      width: 80%; margin: 40px auto;
    }
    .chart { width: 100%; height: 300px; }
  </style>
</head>
<body>

  <h1 style="text-align:center">Pittsburgh Tract Explorer</h1>
  <div id="map"></div>
  <div id="charts">
    <div id="chart1" class="chart"></div>
    <div id="chart2" class="chart"></div>
    <div id="chart3" class="chart"></div>
    <div id="chart4" class="chart"></div>
  </div>

  <script>
    Promise.all([
      fetch("census_tracts.geojson").then(r => r.json()),
      fetch("combined_data.json").then(r => r.json())
    ]).then(([geojson, combined]) => {
    
      // 1) Prep
      const metrics = [
        "Median home value",
        "Median household income",
        "Median monthly contract rent",
        "Vacant housing units"
      ];
      const geoidList = Array.from(
        new Set(combined.map(d => d.GEOID).filter(g => g !== "All Pittsburgh"))
      );
      let selected = [];
    
      // â† Define the Plotly default qualitative palette by hand
      const palette = [
        "#636efa", "#ef553b", "#00cc96", "#ab63fa", "#ffa15a",
        "#19d3f3", "#ff6692", "#b6e880", "#ff97ff", "#fecb52"
      ];
    
      // 2) Draw the map
      Plotly.newPlot("map",[{
        type: "choroplethmapbox",
        geojson, locations: geoidList,
        z: Array(geoidList.length).fill(0),
        featureidkey: "properties.GEOID",
        marker: {
          opacity: 0.5,
          line: {
            color: Array(geoidList.length).fill("white"),
            width: Array(geoidList.length).fill(0.5)
          }
        },
        customdata: geoidList,
        showscale: false
      }], {
        mapbox: { style:"open-street-map", zoom:11, center:{lat:40.4406,lon:-79.9959} },
        margin:{t:30,r:0,l:0,b:0},
        clickmode:"event+select",
        title:"Click a Tract to (De)Select"
      });
    
      // 3) Initial draw of the 4 charts (All Pittsburgh)
      metrics.forEach((m, mi) => {
        const chartId = "chart" + (mi+1);
        const df = combined.filter(d => d.GEOID === "All Pittsburgh");
        const trace = {
          x: df.map(d => d.Year),
          y: df.map(d => d[m]),
          mode: "lines+markers",
          name: "All Pittsburgh",
          line: { color: palette[0] },
          marker: { color: palette[0] }
        };
        Plotly.newPlot(chartId, [trace], {
          title: m,
          xaxis:{ title:"Year" },
          yaxis:{ title:m }
        });
      });
    
      // 4) Updater: recolor map + redraw charts
      function updateMapAndCharts() {
        // map borders
        const newColors = geoidList.map(g =>
          selected.includes(g)
            ? palette[selected.indexOf(g) % palette.length]
            : "white"
        );
        const newWidths = geoidList.map(g =>
          selected.includes(g) ? 3 : 0.5
        );
        Plotly.restyle("map", {
          "marker.line.color": [newColors],
          "marker.line.width": [newWidths]
        });
    
        // determine GEOIDs to plot
        const toPlot = selected.length ? selected : ["All Pittsburgh"];
    
        // redraw each chart via react
        metrics.forEach((m, mi) => {
          const chartId = "chart" + (mi+1);
          const traces = toPlot.map((g, idx) => {
            const df = combined.filter(d => d.GEOID === g);
            const color = palette[idx % palette.length];
            return {
              x: df.map(d => d.Year),
              y: df.map(d => d[m]),
              mode: "lines+markers",
              name: g,
              line: { color },
              marker: { color }
            };
          });
          Plotly.react(chartId, traces, {
            title: m,
            xaxis:{ title:"Year" },
            yaxis:{ title:m }
          });
        });
      }
    
      // 5) Wire up click handler
      document.getElementById("map").on('plotly_click', pts => {
        const geoid = pts.points[0].customdata;
        const idx = selected.indexOf(geoid);
        if (idx > -1) selected.splice(idx,1);
        else            selected.push(geoid);
        updateMapAndCharts();
      });
    
    }).catch(console.error);
    </script>
    
</body>
</html>
